YUI.add("np-audioplayer",function(e,t){function r(e){var t,n,r="";return e>60?(t=Math.floor(e/60),t>=10?r+=t:r+="0"+t,r+=":",n=e%60,n>=10?r+=n:r+="0"+n):e>=10?r+="00:"+e:r+="00:0"+e,r}var n=e.Lang;e.AlbumList=e.Base.create("albumList",e.ModelList,[e.NPModel.Sync],{apis:{read:"/api/albums"},model:e.Album},{ATTRS:{active_album:{value:null},default_alubmIndex:{value:0}}}),e.AudioList=e.Base.create("audioList",e.ModelList,[e.NPModel.Sync],{apis:{read:"/api/albums/{id}"},buildURL:function(e){return n.sub(this.apis[e],{id:this.get("album_id")})},model:e.Audio},{ATTRS:{album_id:{value:null},playing_audios:{value:[]},playing_audioIndex:{value:0},active_audioIndex:{value:null}}}),e.AudioPlayer=e.Base.create("audioPlayer",e.View,[],{template:e.Handlebars.compile('<div class="audioplayer"><div class="audioplayer-panel"><div class="audioplayer-panel-hd"><a class="audioplayer-panel-hd-album">\u4e13\u8f91</a><span class="audioplayer-panel-hd-switch"><span class="audioplayer-panel-hd-switch-roller"></span></span><a class="audioplayer-panel-hd-lyric">\u6b4c\u8bcd</a></div><div class="audioplayer-panel-bd"></div></div><div class="audioplayer-control"><div class="audioplayer-control-main"><div class="audioplayer-control-infos">{{#album}}<a class="audioplayer-control-infos-avatar"><img src="{{{avatar}}}" width="80px" height="80px"/></a><h3>xxx</h3><p>yyy</p><p>{{{name}}}</p>{{/album}}</div><div class="audioplayer-control-boardcast"><div class="audioplayer-control-boardcast-content"><div class="audioplayer-control-boardcast-row1"><a class="audioplayer-control-boardcast-row1-prev"></a><a class="audioplayer-control-boardcast-row1-play"></a><a class="audioplayer-control-boardcast-row1-next"></a><div class="audioplayer-control-boardcast-row1-volume"><div class="audioplayer-control-boardcast-row1-volume-inner" style="width:80px;"></div><span class="audioplayer-control-boardcast-row1-volume-roller" style="left:70px;"></span></div></div><div class="audioplayer-control-boardcast-row2"><span class="audioplayer-control-boardcast-row2-time1">00:00</span><span class="audioplayer-control-boardcast-row2-time2">05:21</span><div class="audioplayer-control-boardcast-row2-process"><div class="audioplayer-control-boardcast-row2-process-value" style=""></div></div></div><div class="audioplayer-control-boardcast-row3"><a class="audioplayer-control-boardcast-row3-repeat">\u5355\u66f2\u91cd\u590d</a><a class="audioplayer-control-boardcast-row3-stochastic">\u968f\u673a\u64ad\u653e</a></div></div></div></div><a class="audioplayer-control-side"><span class="audioplayer-control-side-arrow"></span></a></div></div><audio id="audios-engine"><source /></audio>'),template_info:e.Handlebars.compile('{{#album}}<a class="audioplayer-control-infos-avatar"><img src="{{{avatar}}}" width="80px" height="80px"/></a>{{/album}}{{#audio}}<h3>{{{name}}}</h3><p>{{{author}}}</p>{{/audio}}{{#album}}<p>{{{name}}}</p>{{/album}}'),events:{".audioplayer-control-side":{click:"toggleSideExpand"},".audioplayer-control-infos-avatar":{click:"togglePanelExpand"},".audioplayer-panel-hd-album":{click:"showAlbumList"},".audioplayer-panel-hd-lyric":{click:"showLyric"},".audioplayer-control-boardcast-row3-repeat":{click:"handleRepeat"},".audioplayer-control-boardcast-row3-stochastic":{click:"handleStochastic"},".audioplayer-control-boardcast-row1-play":{click:"playAudioEngine"},".audioplayer-control-boardcast-row1-prev":{click:"playPrevAudio"},".audioplayer-control-boardcast-row1-next":{click:"playNextAudio"},".audioplayer-control-boardcast-row1-volume-roller":{mousedown:"handleVolumeMouseDown"}},initializer:function(){var e=this.get("audioList"),t=this;window.onmouseup=function(){window.onmousemove=null},this._volumeObj={offsetMinLeft:-10,offsetMaxLeft:90}},handleVolumeMouseDown:function(t){var n=this,r=this.get("container").one(".audioplayer-control-boardcast-row1-volume-roller"),i=this.get("container").one(".audioplayer-control-boardcast-row1-volume-inner");e.mix(this._volumeObj,{pageX:t.pageX,left:parseInt(r.getStyle("left")),rollerNode:r,processBar:i}),window.onmousemove=function(e){n.handleVolume(e)}},handleVolume:function(e){var t=this._volumeObj,n=e.pageX-t.pageX,r=t.left+n,i=r-t.offsetMinLeft;if(r<t.offsetMinLeft||r>t.offsetMaxLeft)return!1;t.rollerNode.setStyle("left",r),t.processBar.setStyle("width",i),this.audiosEngine.volume=i/(t.offsetMaxLeft-t.offsetMinLeft)},initVolume:function(){this.audiosEngine.volume=.8},toggleSideExpand:function(e){var t=this.get("container"),n=t.one(".audioplayer"),r=t.one(".audioplayer-panel");n.hasClass("audioplayer-hide")&&r.removeClass("audioplayer-panel-hide"),n.toggleClass("audioplayer-hide")},togglePanelExpand:function(){var e=this.get("container").one(".audioplayer-panel");e.toggleClass("audioplayer-panel-hide")},playAudioEngine:function(e){var t=this.audiosEngine,n=this.get("audioList"),r=this.get("albumList"),i=e.currentTarget;if(i.hasClass("audioplayer-control-boardcast-row1-pause"))t.pause(),this.toPlay("pause");else if(t.src)t.play(),this.toPlay("play");else if(n.get("album_id")===null){var s=r.get("default_alubmIndex"),o=r.item(s).get("id");n.set("album_id",o).load(function(e){e||(r.getById(o).set("audio_collection",n.toJSON()),r.set("active_album",r.getById(o)),n.set("active_audioIndex",s+"-0",{smooth:!1}))})}else{var u=r.getById(n.get("album_id"));r.set("active_album",u),n.set("active_audioIndex",r.indexOf(u)+"-0",{smooth:!1})}i.toggleClass("audioplayer-control-boardcast-row1-pause")},playPrevAudio:function(){if(this.get("audioList").get("active_audioIndex")===null)return!1;this.get("container").one(".audioplayer-control-boardcast-row1-play").addClass("audioplayer-control-boardcast-row1-pause");var e=this.get("audioList"),t=this.get("albumList"),n=e.get("playing_audioIndex"),r=e.get("playing_audios"),i=t.get("active_album").get("audio_collection"),s;e.set("playing_audioIndex",(n-1+r.length)%r.length),activeAudioId=r[e.get("playing_audioIndex")].id;for(var o=0,u=i.length;o<u;o++)if(i[o].id===activeAudioId){s=o;break}
activeAudio=r[e.get("playing_audioIndex")],e.set("active_audioIndex",e.get("active_audioIndex").split("-")[0]+"-"+s,{smooth:!0})},playNextAudio:function(){if(this.get("audioList").get("active_audioIndex")===null)return!1;this.get("container").one(".audioplayer-control-boardcast-row1-play").addClass("audioplayer-control-boardcast-row1-pause");var e=this.get("audioList"),t=this.get("albumList"),n=e.get("playing_audioIndex"),r=e.get("playing_audios"),i=t.get("active_album").get("audio_collection"),s;e.set("playing_audioIndex",(n+1)%r.length),activeAudioId=r[e.get("playing_audioIndex")].id;for(var o=0,u=i.length;o<u;o++)if(i[o].id===activeAudioId){s=o;break}e.set("active_audioIndex",e.get("active_audioIndex").split("-")[0]+"-"+s,{smooth:!0})},toPlay:function(e){var t=this.get("container"),n=230,i=t.one(".audioplayer-control-boardcast-row2-process-value"),s=this.get("audioList"),o=s.get("playing_audios")[s.get("playing_audioIndex")],u=o.duration,a=this;e==="play"?(this.timer&&clearInterval(this.timer),this.timer=setInterval(function(){var e=a.audiosEngine.currentTime,s=e/u;i.setAttribute("style","width: "+s*n+"px;"),t.one(".audioplayer-control-boardcast-row2-time1").setHTML(r(Math.round(e)))},1e3)):e==="pause"&&clearInterval(this.timer)},resetProcess:function(){var e=this.get("container"),t=this.getActiveAudioObj();e.one(".audioplayer-control-boardcast-row2-time1").setHTML("00:00"),e.one(".audioplayer-control-boardcast-row2-time2").setHTML(r(t.duration)),e.one(".audioplayer-control-boardcast-row2-process-value").setAttribute("style","width: 0px;")},getActiveAudioObj:function(){var e=this.get("albumList").get("active_album");if(e===null)return null;var t=e.get("audio_collection"),n=+this.get("audioList").get("active_audioIndex").split("-")[1];return t[n]},createCurrentAudioList:function(){var t=this.get("audioList"),n=this.get("albumList").get("active_album"),r=n.get("audio_collection"),i=+t.get("active_audioIndex").split("-")[1],s=r.length,o=[];t.set("playing_audioIndex",0),e.Array.each(r,function(e,t){t<i?o[s-i+t]=e:o[t-i]=e});if(this.get("isStochastic")){var u=o.shift();o=this.resortArray(o),o.unshift(u)}t.set("playing_audios",o)},loadAudio:function(){var e=this.get("audioList"),t=e.get("playing_audioIndex"),n=e.get("playing_audios");this.audiosEngine.src=n[t].src},bindAudioEngine:function(){var e=this.audiosEngine,t=this.get("albumList"),n=this.get("audioList"),r=this;e.addEventListener("ended",function(e){if(!r.get("isRepeatOne")){var i=n.get("playing_audioIndex"),s=n.get("playing_audios"),o=t.get("active_album").get("audio_collection"),u;n.set("playing_audioIndex",(i+1)%s.length),activeAudioId=s[n.get("playing_audioIndex")].id;for(var a=0,f=o.length;a<f;a++)if(o[a].id===activeAudioId){u=a;break}n.set("active_audioIndex",n.get("active_audioIndex").split("-")[0]+"-"+u,{smooth:!0})}else r.audiosEngine.play()},!1),n.after("active_audioIndexChange",function(e){var n=+e.newVal.split("-")[1],i=r.get("container").one(".audioplayer-control-infos"),s=t.get("active_album"),o={};o.audio=s.get("audio_collection")[n],o.album=s.toJSON(),r.resetProcess(),i.setHTML(r.template_info(o)),e.smooth||r.createCurrentAudioList(),r.loadAudio(),r.audiosEngine.play(),r.toPlay("play"),r.lyricView&&r.lyricView.set("lyric",o.audio.lyric)})},resortArray:function(e){if(e.length<=1)return e;var t=[];for(var n=0,r=e.length;n<r;n++){var i=Math.floor(Math.random()*e.length),s=e.splice(i,1)[0];t.push(s)}return t},handleRepeat:function(e){var t=e.currentTarget;t.hasClass("audioplayer-control-boardcast-row3-repeat-active")?(this.set("isRepeatOne",!1),this.get("audioList").get("active_audioIndex")!==null&&this.createCurrentAudioList()):(this.set("isRepeatOne",!0),this.set("isStochastic",!1),this.get("container").one(".audioplayer-control-boardcast-row3-stochastic").removeClass("audioplayer-control-boardcast-row3-stochastic-active")),t.toggleClass("audioplayer-control-boardcast-row3-repeat-active")},handleStochastic:function(e){var t=e.currentTarget;t.hasClass("audioplayer-control-boardcast-row3-stochastic-active")?this.set("isStochastic",!1):(this.set("isStochastic",!0),this.set("isRepeatOne",!1),this.get("container").one(".audioplayer-control-boardcast-row3-repeat").removeClass("audioplayer-control-boardcast-row3-repeat-active")),t.toggleClass("audioplayer-control-boardcast-row3-stochastic-active"),this.get("audioList").get("active_audioIndex")!==null&&this.createCurrentAudioList()},showAlbumList:function(){var e=this.get("container"),t=this,n;this.albumListView?n=this.albumListView:n=this.albumListView=new i({albumList:this.get("albumList"),audioList:this.get("audioList")}),e.one(".audioplayer-panel-hd-switch").removeClass("audioplayer-panel-hd-switch-right"),e.one(".audioplayer-panel-bd").setHTML(n.render().get("container")),n.on("audioRestartChange",function(){t.resetProcess()})},showLyric:function(){var e=this.get("container"),t=this.getActiveAudioObj(),n=t?t.lyric:null,r;this.lyricView?r=this.lyricView:r=this.lyricView=new s({lyric:n}),e.one(".audioplayer-panel-hd-switch").addClass("audioplayer-panel-hd-switch-right"),e.one(".audioplayer-panel-bd").setHTML(r.render().get("container"))},render:function(){var e=this.get("albumList"),t=e.item(e.get("default_alubmIndex")),n=this.get("container"),r={};return r.album=t.toJSON(),n.setHTML(this.template(r)),this.audiosEngine=document.getElementById("audios-engine"),this.showAlbumList(),this.bindAudioEngine(),this.initVolume(),this}},{ATTRS:{isRepeatOne:{value:!1},isStochastic:{value:!1},audioList:{value:new e.AudioList}}});var i=e.Base.create("albumListView",e.View,[],{template1:e.Handlebars.compile('<ul class="audioplayer-panel-albumlist">{{#albumList}}<li class="audioplayer-panel-album"><a class="audioplayer-panel-album-avatar" data-id="{{{id}}}"><img src="{{{avatar}}}" width="120" height="120"/></a><p class="audioplayer-panel-album-name">{{{name}}}<span class="audioplayer-panel-album-num">({{{audio_num}}})</span></p></li>{{/albumList}}</ul>'),template2:e.Handlebars.compile('<table class="audioplayer-panel-songlist">{{#songList}}<tr class="audioplayer-panel-song{{#if selected}} audioplayer-panel-song-selected{{/if}}{{#if even}} audioplayer-panel-song-even{{/if}}" data-index={{{index}}}><td>{{{num}}}</td><td>{{{name}}}</td><td>{{{duration}}}</td><td>{{{author}}}</td><td>{{#with belong_album}}{{{name}}}{{/with}}</td></tr>{{/songList}}</table><p><button class="button-normal-s audioplayer-panel-songlist-back">\u8fd4\u56de</button></p>'
),events:{".audioplayer-panel-album-avatar":{click:"showAudios"},".audioplayer-panel-song":{mouseover:"addSongHover",mouseout:"removeSongHover",click:"changeAudio"},".audioplayer-panel-songlist-back":{click:"trunBackToAlbums"}},initializer:function(){var e=this.get("audioList"),t=this;e.after("active_audioIndexChange",function(){t.get("activeTemplate")===2&&t.renderTemplate2()})},addSongHover:function(e){e.currentTarget.addClass("audioplayer-panel-song-hover")},removeSongHover:function(e){e.currentTarget.removeClass("audioplayer-panel-song-hover")},changeAudio:function(t){var n=t.currentTarget.getAttribute("data-index"),r=this.get("albumList"),i=this.get("audioList");r.set("active_album",r.getById(i.get("album_id"))),e.one(".audioplayer-control-boardcast-row1-play").addClass("audioplayer-control-boardcast-row1-pause"),i.get("active_audioIndex")===n?(document.getElementById("audios-engine").currentTime=0,this.set("audioRestart",!this.get("audioRestart"))):(i.set("active_audioIndex",n),this.renderTemplate2())},showAudios:function(e){var t=+e.currentTarget.getAttribute("data-id"),n=this.get("albumList"),r=this.get("audioList"),i=this;r.setAttrs({album_id:t}).load(function(e,s){e||(n.getById(t).set("audio_collection",r.toJSON()),i.renderTemplate2())})},trunBackToAlbums:function(){this.renderTemplate1()},renderTemplate1:function(){var e=this.get("container"),t=this.get("albumList"),n={};n.albumList=t.toJSON(),e.setHTML(this.template1(n)),this.set("activeTemplate",1)},renderTemplate2:function(){var t=this.get("container"),n=this.get("audioList"),i=this.get("albumList"),s=n.get("active_audioIndex"),o=i.getById(n.get("album_id")),u=i.indexOf(o),a={};a.songList=e.Array.map(n.toJSON(),function(e,t){e.index=u+"-"+t,e.num=t+1,e.even=t%2===0,e.duration=r(e.duration);if(s!==null){var n=s.split("-");+n[0]===u&&+n[1]===t&&(e.selected=!0)}return e}),t.setHTML(this.template2(a)),this.set("activeTemplate",2)},render:function(){return this.renderTemplate1(),this}},{ATTRS:{activeTemplate:{value:null},audioRestart:{value:!1}}}),s=e.Base.create("lyricView",e.View,[],{template:'<div class="audioplayer-panel-lyric"></div>',initializer:function(){var e=this;this.after("lyricChange",function(){e.render()}),this.audiosEngine=document.getElementById("audios-engine")},initScrollLyric:function(){var e=this,t=this.get("container").one(".audioplayer-panel-lyric"),n=t.all("p");this.timer&&clearInterval(this.timer),this.timer=setInterval(function(){var r=e.audiosEngine.currentTime;n.removeClass("audioplayer-panel-lyric-item-selected");for(var i=0,s=n.size();i<s;i++)if(r<+n.item(i).getAttribute("data-time")){i===0?n.item(i).addClass("audioplayer-panel-lyric-item-selected"):(n.item(i-1).addClass("audioplayer-panel-lyric-item-selected"),n.item(i-1).get("offsetTop")>240&&t.set("scrollTop",n.item(i-1).get("offsetTop")-240));break}},1e3)},render:function(){var e=this.get("container"),t=this.get("lyric"),n="";return t===null?n='<p class="audioplayer-panel-lyric-nonlyric">\u8bf7\u5148\u64ad\u653e\u6b4c\u66f2\uff01</p>':n=t.replace(/\[(.*?)\]([^\[]*)/g,function(e,t,n){var r=t.split(":"),i=+r[0]*60+ +r[1];return'<p class="audioplayer-panel-lyric-item" data-time="'+i+'">'+n+"</p>"}),e.setHTML(this.template),e.one(".audioplayer-panel-lyric").setHTML(n),this.initScrollLyric(),this}},{ATTRS:{lyric:{value:null}}})},"@VERSION@",{requires:["view","model-list","handlebars","np-models","node-style"]});
